name: Build SecOS
on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - 'buildeb/**'
      - 'config/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'buildeb/**'
      - 'config/**'
jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: >-
        --cap-add=SYS_ADMIN 
        --cap-add=MKNOD
        --security-opt apparmor=unconfined
        --device=/dev/loop-control 
        --device=/dev/loop0
      env:
        TERM: xterm-256color
    steps:
    - name: Install git
      run: |
        set -x
        apt-get update
        apt-get install -y git
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    - name: Install dependencies
      run: |
        set -x
        apt-get update
        DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends -V \
        build-essential \
        procps \
        psmisc \
        apt-utils \
        debootstrap \
        squashfs-tools \
        xorriso \
        isolinux \
        syslinux-efi \
        grub-pc-bin \
        grub-efi-amd64-bin \
        grub-efi-ia32-bin \
        mtools \
        dosfstools \
        wget \
        unzip \
        curl \
        sudo \
        ca-certificates \
        device-tree-compiler \
        vim-common \
        parted \
        util-linux \
        kmod
    - name: Modify build script
      run: |
        set -x
        cd buildeb
        # Remove sudo commands as we're running as root
        sed -i 's/sudo //g' buildeb.sh
    - name: Build OS
      run: |
        set -x
        cd buildeb
        ./buildeb.sh
    - name: List artifacts
      if: always()
      run: |
        set -x
        cd buildeb
        ls -la
        echo "Contents of current directory:"
        pwd
        echo "System memory status:"
        free -h || true
        echo "Disk space:"
        df -h
