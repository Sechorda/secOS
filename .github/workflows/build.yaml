name: Build SecOS

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - 'buildeb/**'
      - 'config/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'buildeb/**'
      - 'config/**'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TERM: xterm-256color
      DEBIAN_FRONTEND: noninteractive

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup sudo
      run: |
        sudo apt-get update
        sudo apt-get install -y sudo

    - name: Modify build script
      run: |
        cd buildeb
        # Find the line number where main() starts
        main_line=$(grep -n "^main()" buildeb.sh | cut -d: -f1)
        # Delete everything after main() and replace with simplified version
        sed -i "${main_line},\$c\\main() {\n    if [ -d \"\${LIVE_BOOT_DIR}\" ]; then\n        sudo rm -rf \"\${LIVE_BOOT_DIR}\"\n    fi\n    setup_build_env\n    bootstrap_debian\n    install_kernel_and_packages\n    install_github_packages\n    configure_system\n    create_filesystem\n    configure_boot_loaders\n    create_efi_images\n    create_uefi_boot_image\n    create_iso_and_ova\n}\n\nmain" buildeb.sh

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y apt-utils debootstrap squashfs-tools xorriso \
        isolinux syslinux-efi grub-pc-bin grub-efi-amd64-bin grub-efi-ia32-bin \
        mtools dosfstools wget unzip virtualbox

    - name: Build OS
      run: cd buildeb && sudo ./buildeb.sh
