name: Build and Upload secOS
on:
  workflow_dispatch:

env:
  DEBIAN_FRONTEND: noninteractive

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
      options: --privileged

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install initial requirements
        run: |
          apt-get update
          apt-get install -y ca-certificates curl gpg wget

      - name: Install build dependencies and VirtualBox
        run: |
          # Add VirtualBox repository
          wget -O- https://www.virtualbox.org/download/oracle_vbox_2016.asc | gpg --dearmor > /usr/share/keyrings/oracle-virtualbox-2016.gpg
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/oracle-virtualbox-2016.gpg] https://download.virtualbox.org/virtualbox/debian bookworm contrib" > /etc/apt/sources.list.d/virtualbox.list
          
          # Update and install dependencies
          apt-get update
          apt-get install -y \
            apt-utils \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-efi \
            grub-pc-bin \
            grub-efi-amd64-bin \
            grub-efi-ia32-bin \
            mtools \
            dosfstools \
            wget \
            unzip \
            curl \
            gpg \
            linux-headers-amd64
          
          # Install VirtualBox
          apt-get install -y virtualbox-7.0

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | bash
          mkdir -p ~/.config/rclone

      - name: Configure rclone
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${R2_ACCESS_KEY_ID}
          secret_access_key = ${R2_SECRET_ACCESS_KEY}
          endpoint = https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com
          acl = private
          bucket_name = ${R2_BUCKET_NAME}
          EOF

      - name: Run build script
        env:
          TERM: xterm-256color
        run: |
          cd buildeb
          chmod +x ./buildeb.sh
          sed -i 's/clear/printf "\\033[2J\\033[H"/' ./buildeb.sh
          # Run the script but only show errors
          ./buildeb.sh 2>&1 | grep -i 'error\|fail\|fatal'

      - name: Upload files to R2
        run: |
          cd buildeb
          rclone copy secOS.iso r2:${R2_BUCKET_NAME}
          rclone copy secOS.ova r2:${R2_BUCKET_NAME}

      - name: Cleanup
        if: always()
        run: |
          cd buildeb
          rm -f secOS.iso secOS.ova
