name: Build SecOS ISO
  workflow_dispatch:
  
jobs:
  build-secOS:
    runs-on: ubuntu-latest
    env:
      TERM: xterm-256color
      DEBIAN_FRONTEND: noninteractive
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Install Dependencies
      run: |
        sudo apt-get update
        wget -O- https://www.virtualbox.org/download/oracle_vbox_2016.asc | sudo gpg --dearmor --yes --output /usr/share/keyrings/oracle-virtualbox-2016.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/oracle-virtualbox-2016.gpg] https://download.virtualbox.org/virtualbox/debian $(lsb_release -cs) contrib" | sudo tee /etc/apt/sources.list.d/virtualbox.list
        sudo apt-get update
        sudo apt-get install -y apt-utils debootstrap squashfs-tools xorriso \
          isolinux syslinux-efi grub-pc-bin grub-efi-amd64-bin grub-efi-ia32-bin \
          mtools dosfstools wget unzip git curl qemu-system-x86 qemu-utils ovmf \
          virtualbox-7.0

    - name: Build secOS
      run: |
        sudo mount -t proc proc /proc || echo "/proc already mounted"
        chmod +x buildeb/buildeb.sh
        cd buildeb
        sudo ./buildeb.sh

    - name: Upload to Cloudflare R2
      env:
        R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
        R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
        R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
      run: |
        curl https://rclone.org/install.sh | sudo bash
        mkdir -p ~/.config/rclone
        cat > ~/.config/rclone/rclone.conf << EOF
        [r2]
        type = s3
        provider = Cloudflare
        access_key_id = ${R2_ACCESS_KEY_ID}
        secret_access_key = ${R2_SECRET_ACCESS_KEY}
        endpoint = ${R2_ENDPOINT}
        acl = private
        EOF
        rclone copy buildeb/secOS.iso r2:${R2_BUCKET_NAME}
