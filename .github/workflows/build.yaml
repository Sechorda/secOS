name: Build and Upload secOS
on:
  workflow_dispatch:
env:
  DEBIAN_FRONTEND: noninteractive
jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure APT
        run: |
          sudo apt-get update
          # Enable all repositories
          sudo sed -i 's/^deb http/deb [trusted=yes] http/' /etc/apt/sources.list
          sudo sed -i 's/^# deb-src/deb-src/' /etc/apt/sources.list
          # Add contrib and non-free repositories
          sudo sed -i 's/main/main contrib non-free non-free-firmware/g' /etc/apt/sources.list
          sudo apt-get update

      - name: Install build dependencies
        run: |
          sudo apt-get install -y \
            apt-utils \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-efi \
            grub-pc-bin \
            grub-efi-amd64-bin \
            grub-efi-ia32-bin \
            mtools \
            dosfstools \
            wget \
            unzip \
            virtualbox \
            curl \
            gpg \
            systemd-container \
            arch-install-scripts

      - name: Setup chroot environment
        run: |
          sudo mkdir -p LIVE_BOOT/chroot
          # Mount virtual filesystems for chroot
          for mount in proc sys dev dev/pts; do
            sudo mkdir -p LIVE_BOOT/chroot/$mount
            sudo mount --bind /$mount LIVE_BOOT/chroot/$mount || true
          done
          
          # Create resolv.conf for network access inside chroot
          sudo cp /etc/resolv.conf LIVE_BOOT/chroot/etc/resolv.conf || true

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone

      - name: Configure rclone
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${R2_ACCESS_KEY_ID}
          secret_access_key = ${R2_SECRET_ACCESS_KEY}
          endpoint = https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com
          acl = private
          bucket_name = ${R2_BUCKET_NAME}
          EOF

      - name: Run build script
        env:
          TERM: xterm-256color
        run: |
          cd buildeb
          sudo chmod +x ./buildeb.sh
          sudo sed -i 's/clear/printf "\\033[2J\\033[H"/' ./buildeb.sh
          # Enable more verbose output for debugging
          sudo bash -x ./buildeb.sh 2>&1 | tee build.log
          # Check for specific errors
          if grep -iE 'error|fail|fatal' build.log; then
            echo "Build encountered errors, check build.log for details"
            exit 1
          fi

      - name: Upload files to R2
        run: |
          cd buildeb
          rclone copy secOS.iso r2:${R2_BUCKET_NAME}
          rclone copy secOS.ova r2:${R2_BUCKET_NAME}

      - name: Cleanup
        if: always()
        run: |
          cd buildeb
          # Unmount virtual filesystems in reverse order
          for mount in dev/pts dev sys proc; do
            sudo umount -l LIVE_BOOT/chroot/$mount || true
          done
          rm -f secOS.iso secOS.ova
          sudo rm -rf LIVE_BOOT
