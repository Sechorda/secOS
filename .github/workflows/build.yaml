name: Build SecOS

on:
  workflow_dispatch:  # Allows manual triggering
  push:
    branches: [ "main" ]
    paths:
      - 'buildeb/**'
      - 'config/**'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'buildeb/**'
      - 'config/**'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TERM: xterm-256color
      DEBIAN_FRONTEND: noninteractive

    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Setup sudo
      run: |
        sudo apt-get update
        sudo apt-get install -y sudo

    - name: Modify build script
      run: |
        # Create a temporary file for modifications
        sed -e '/^spinner=/d' \
            -e '/display_spinner/d' \
            -e '/tput/d' \
            -e '/clear/d' \
            -e '/^update_step/d' \
            -e '/print_centered_ascii_art()/,/^print_centered_ascii_art$/{/print_centered_ascii_art/!d}' \
            -e 's/ \&>\/dev\/null//' \
            -e 's/ >\/dev\/null//' \
            -e 's/ 2>\&1//' \
            buildeb/buildeb.sh > buildeb/buildeb_modified.sh
        
        # Make the new script executable
        chmod +x buildeb/buildeb_modified.sh

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y apt-utils debootstrap squashfs-tools xorriso \
        isolinux syslinux-efi grub-pc-bin grub-efi-amd64-bin grub-efi-ia32-bin \
        mtools dosfstools wget unzip virtualbox

    - name: Build OS
      run: cd buildeb && sudo ./buildeb_modified.sh
