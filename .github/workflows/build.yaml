name: Build secOS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y apt-utils debootstrap squashfs-tools xorriso \
        isolinux syslinux-efi grub-pc-bin grub-efi-amd64-bin grub-efi-ia32-bin \
        mtools dosfstools wget unzip virtualbox
        
    - name: Set execute permissions
      run: chmod +x buildeb/buildeb.sh
      
    - name: Modify build script
      run: |
        # Add build info at top of script
        sed -i "2i\# Build Date: 2024-12-19 18:45:37\n# User: Sechorda\n" buildeb/buildeb.sh
        
        # Define term variable
        sed -i "3i\term=\"xterm-256color\"" buildeb/buildeb.sh
        
        # Remove spinner and status tracking
        sed -i '/^spinner=/d' buildeb/buildeb.sh
        sed -i '/^build_steps=/,/^)/d' buildeb/buildeb.sh
        sed -i '/^# Function to update step status/,/^}/d' buildeb/buildeb.sh
        sed -i '/^update_step/d' buildeb/buildeb.sh
        sed -i '/display_spinner/d' buildeb/buildeb.sh
        sed -i '/^# Spinner characters/d' buildeb/buildeb.sh
        
        # Remove async execution
        sed -i 's/) \&$/)/' buildeb/buildeb.sh
        
        # Remove output redirections to allow terminal output
        sed -i 's/ *&>[[:space:]]*\/dev\/null//g' buildeb/buildeb.sh
        sed -i 's/ *>[[:space:]]*\/dev\/null//g' buildeb/buildeb.sh
        sed -i 's/ *2>&1//g' buildeb/buildeb.sh
        
        # Clean up main function
        sed -i '/for i in "${!build_steps\[@\]}"/,/done/d' buildeb/buildeb.sh
        sed -i '/print_centered_ascii_art/d' buildeb/buildeb.sh
      
    - name: Run build script
      run: sudo ./buildeb/buildeb.sh
