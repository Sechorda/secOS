name: Build and Upload secOS
on:
  workflow_dispatch:
env:
  DEBIAN_FRONTEND: noninteractive
jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            apt-utils \
            debootstrap \
            squashfs-tools \
            xorriso \
            isolinux \
            syslinux-efi \
            grub-pc-bin \
            grub-efi-amd64-bin \
            grub-efi-ia32-bin \
            mtools \
            dosfstools \
            wget \
            unzip \
            virtualbox \
            curl \
            gpg

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone

      - name: Configure rclone
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
          R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          cat > ~/.config/rclone/rclone.conf << EOF
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${R2_ACCESS_KEY_ID}
          secret_access_key = ${R2_SECRET_ACCESS_KEY}
          endpoint = https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com
          acl = private
          bucket_name = ${R2_BUCKET_NAME}
          EOF

      - name: Check directory contents
        run: |
          ls -la buildeb/

      - name: Check script permissions and format
        run: |
          cd buildeb
          file ./buildeb.sh
          cat -A ./buildeb.sh | head -n 5

      - name: Run build script
        env:
          TERM: xterm-256color
        run: |
          cd buildeb
          sudo chmod +x ./buildeb.sh
          sudo sed -i 's/clear/printf "\\033[2J\\033[H"/' ./buildeb.sh
          # Run with full output for debugging
          sudo bash -x ./buildeb.sh

      - name: Upload files to R2
        run: |
          cd buildeb
          rclone copy secOS.iso r2:${R2_BUCKET_NAME}
          rclone copy secOS.ova r2:${R2_BUCKET_NAME}

      - name: Cleanup
        if: always()
        run: |
          cd buildeb
          rm -f secOS.iso secOS.ova
